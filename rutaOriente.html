<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Recorrido en Coche - Campeche</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      margin: 0;

      font-family: "Segoe UI", sans-serif;

      background-color: #f8f8f8;
    }

    header {
      background-color: #702c37;

      color: #b38b28;

      padding: 20px;

      text-align: center;

      position: relative;
    }

    .logo {
      position: absolute;

      top: 35px;

      left: 10px;

      height: 50px;

      width: auto;

      transition: all 0.3s ease;
    }

    @media screen and (max-width: 768px) {
      .logo {
        height: 40px;

        top: 5px;

        left: 5px;
      }

      header h1 {
        font-size: 1.5em;

        padding: 10px 0;
      }
    }

    .container {
      display: flex;

      position: relative;

      height: 500px;

      width: 90%;

      max-width: 1200px;

      margin: 20px auto;

      border-radius: 15px;

      box-shadow: 0 0 15px #00000022;

      overflow: hidden;
    }

    #map {
      flex: 1;

      height: 100%;

      z-index: 1;
    }

    /* Panel lateral */

    #sidebar {
      position: absolute;

      top: 0;

      right: -400px;

      width: 400px;

      height: 100%;

      background: white;

      box-shadow: -4px 0 20px rgba(0, 0, 0, 0.15);

      transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);

      z-index: 1000;

      overflow-y: auto;

      border-left: 3px solid #8b0000;
    }

    #sidebar.active {
      right: 0;
    }

    .sidebar-header {
      display: flex;

      justify-content: space-between;

      align-items: flex-start;

      padding: 20px;

      border-bottom: 2px solid #e5e7eb;

      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);

      position: sticky;

      top: 0;

      z-index: 10;
    }

    .header-content {
      flex: 1;
    }

    .sidebar-header h2 {
      color: #8b0000;

      font-size: 1.4rem;

      margin: 0 0 8px 0;

      font-weight: 700;

      line-height: 1.3;
    }

    .distance-info {
      display: flex;

      align-items: center;

      gap: 8px;

      margin-top: 8px;
    }

    .distance-label {
      font-size: 14px;

      color: #6b7280;

      font-weight: 500;
    }

    .distance-value {
      font-size: 14px;

      color: #059669;

      font-weight: 600;

      background: #d1fae5;

      padding: 2px 8px;

      border-radius: 12px;
    }

    .close-btn {
      background: #8b0000;

      color: white;

      border: none;

      padding: 8px 12px;

      border-radius: 8px;

      cursor: pointer;

      font-size: 14px;

      font-weight: 600;

      transition: all 0.3s ease;

      margin-left: 15px;
    }

    .close-btn:hover {
      background: #a30000;
    }

    /* Carrusel de im√°genes */

    .image-carousel {
      padding: 20px;
    }

    .carousel-container {
      position: relative;

      background: #f8fafc;

      border-radius: 12px;

      overflow: hidden;

      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);

      border: 1px solid #e5e7eb;
    }

    .carousel-images {
      position: relative;

      height: 250px;

      overflow: hidden;
    }

    .carousel-image {
      position: absolute;

      top: 0;

      left: 0;

      width: 100%;

      height: 100%;

      object-fit: cover;

      opacity: 0;

      transition: opacity 0.6s ease-in-out;

      border-radius: 12px 12px 0 0;
    }

    .carousel-image.active {
      opacity: 1;
    }

    .carousel-controls {
      display: flex;

      justify-content: space-between;

      align-items: center;

      padding: 15px;

      background: white;
    }

    .carousel-btn {
      background: #8b0000;

      color: white;

      border: none;

      padding: 8px 12px;

      border-radius: 8px;

      cursor: pointer;

      font-size: 12px;

      font-weight: 600;

      transition: all 0.3s ease;
    }

    .carousel-btn:hover {
      background: #a30000;
    }

    .carousel-indicators {
      display: flex;

      gap: 8px;

      align-items: center;
    }

    .indicator {
      width: 10px;

      height: 10px;

      border-radius: 50%;

      background: #d1d5db;

      cursor: pointer;

      transition: all 0.3s ease;
    }

    .indicator.active {
      background: #8b0000;

      transform: scale(1.2);
    }

    .carousel-progress {
      height: 3px;

      background: #e5e7eb;

      position: relative;

      overflow: hidden;
    }

    .progress-bar {
      height: 100%;

      background: #8b0000;

      width: 0%;

      transition: none;
    }

    /* Descripci√≥n del sitio */

    .site-description {
      padding: 0 20px 20px;
    }

    .site-description p {
      line-height: 1.6;

      color: #374151;

      margin-bottom: 15px;

      text-align: justify;

      font-size: 14px;

      background: #f9fafb;

      padding: 15px;

      border-radius: 10px;

      border-left: 4px solid #8b0000;
    }

    .action-buttons {
      display: flex;

      gap: 10px;

      flex-direction: column;
    }

    .speak-btn,
    .center-btn,
    .route-btn {
      background: #8b0000;

      color: white;

      border: none;

      padding: 10px 15px;

      border-radius: 8px;

      cursor: pointer;

      font-size: 14px;

      font-weight: 600;

      transition: all 0.3s ease;

      display: flex;

      align-items: center;

      justify-content: center;

      gap: 8px;
    }

    #pauseBtn {
      background: #6b7280;
      /* gris oscuro */

      color: white;

      border: none;

      padding: 10px 15px;

      border-radius: 8px;

      cursor: pointer;

      font-size: 14px;

      font-weight: 600;

      transition: all 0.3s ease;

      display: none;
      /* para ocultarlo por defecto */
    }

    #pauseBtn:hover {
      background: #4b5563;
    }

    .speak-btn:hover,
    .center-btn:hover,
    .route-btn:hover {
      background: #a30000;
    }

    .speak-btn:disabled {
      background: #9ca3af;

      cursor: not-allowed;
    }

    /* Bot√≥n especial para crear ruta en sidebar */

    .route-btn {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
    }

    .route-btn:hover {
      background: linear-gradient(135deg, #047857 0%, #065f46 100%);
    }

    #distance,
    #description {
      text-align: center;

      margin-top: 10px;

      font-size: 1.2em;

      font-weight: bold;
    }

    #description {
      padding: 10px;

      margin-bottom: 10px;
    }

    .btn-red-vino {
      background-color: #8b0000;

      color: #fff;

      border: none;

      cursor: pointer;

      transition: background 0.3s;

      padding: 6px 12px;

      border-radius: 8px;

      margin: 2px;
    }

    .btn-red-vino:hover {
      background-color: #a30000;
    }

    /* Bot√≥n cancelar ruta */

    .btn-cancel {
      background-color: #dc3545;

      color: #fff;

      border: none;

      cursor: pointer;

      transition: background 0.3s;

      padding: 6px 12px;

      border-radius: 8px;

      margin: 2px;
    }

    .btn-cancel:hover {
      background-color: #c82333;
    }

    /* Contenedor de botones de control */

    .route-controls {
      text-align: center;

      margin-top: 10px;

      display: flex;

      justify-content: center;

      gap: 10px;

      flex-wrap: wrap;
    }

    /* Estado de ruta activa */

    .route-status {
      background: #d1fae5;

      color: #065f46;

      padding: 8px 15px;

      border-radius: 8px;

      margin: 10px auto;

      display: none;

      max-width: 300px;

      text-align: center;

      font-weight: 600;

      border: 1px solid #10b981;
    }

    .route-status.active {
      display: block;
    }

    /* Informaci√≥n del recorrido */

    .tour-info {
      background: #e0f2fe;

      color: #0277bd;

      padding: 10px 15px;

      border-radius: 8px;

      margin: 10px auto;

      max-width: 400px;

      text-align: center;

      font-size: 14px;

      border: 1px solid #29b6f6;
    }

    /* Bot√≥n ir al recorrido en popup */

    .popup-route-btn {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);

      color: white;

      border: none;

      padding: 8px 16px;

      border-radius: 6px;

      cursor: pointer;

      font-size: 12px;

      font-weight: 600;

      margin-top: 8px;

      width: 100%;

      transition: all 0.3s ease;

      box-shadow: 0 2px 4px rgba(5, 150, 105, 0.2);
    }

    .popup-route-btn:hover {
      background: linear-gradient(135deg, #047857 0%, #065f46 100%);

      transform: translateY(-1px);

      box-shadow: 0 4px 8px rgba(5, 150, 105, 0.3);
    }

    .lang-switch {
      position: absolute;

      top: 10px;

      right: 10px;
    }

    img {
      max-width: 100%;

      height: auto;

      border-radius: 10px;

      margin-bottom: 10px;
    }

    .popup-btn {
      display: inline-block;

      margin-top: 10px;

      width: 100%;

      text-align: center;
    }

    .btn-back {
      background-color: #8b0000;

      color: #fff;

      padding: 10px 20px;

      border: none;

      border-radius: 8px;

      font-size: 1.2em;

      cursor: pointer;

      margin-top: 20px;

      margin-bottom: 40px;

      transition: background-color 0.3s;
    }

    .btn-back:hover {
      background-color: #a30000;
    }

    /* Popup simplificado */

    .simple-popup {
      text-align: center;

      padding: 10px;

      max-width: 200px;
    }

    .simple-popup h3 {
      margin: 0 0 10px 0;

      font-size: 16px;

      font-weight: bold;

      color: #8b0000;
    }

    .simple-popup img {
      width: 100%;

      height: 120px;

      object-fit: cover;

      border-radius: 8px;

      margin: 0;
    }

    /* Responsive */

    @media (max-width: 768px) {
      #sidebar {
        width: 100%;

        right: -100%;
      }

      .carousel-images {
        height: 200px;
      }

      .sidebar-header {
        padding: 15px;
      }

      .sidebar-header h2 {
        font-size: 1.2rem;
      }

      .image-carousel {
        padding: 15px;
      }

      .site-description {
        padding: 0 15px 15px;
      }

      .route-controls {
        flex-direction: column;

        align-items: center;
      }

      .popup-route-btn {
        font-size: 11px;

        padding: 6px 12px;
      }
    }

    /* Scrollbar personalizado */

    #sidebar::-webkit-scrollbar {
      width: 6px;
    }

    #sidebar::-webkit-scrollbar-track {
      background: #f1f5f9;
    }

    #sidebar::-webkit-scrollbar-thumb {
      background: #cbd5e1;

      border-radius: 3px;
    }

    #sidebar::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    @media (max-width: 768px) {
      #siteButtons button {
        flex: 1 1 100%;

        max-width: 100%;

        font-size: 16px;

        padding: 12px;
      }

      #siteMenu h2 {
        font-size: 1.2rem;
      }
    }

    .number-icon {
      pointer-events: none;
      /* Para que no bloquee clics en el √≠cono */
    }

    .number-label {
      background-color: #8b0000;

      color: white;

      font-size: 14px;

      font-weight: bold;

      border-radius: 50%;

      width: 22px;

      height: 22px;

      display: flex;

      align-items: center;

      justify-content: center;

      box-shadow: 0 0 4px rgba(0, 0, 0, 0.3);
    }
  </style>
</head>

<body>
  <header>
    <img src="img/LogoINAH_Dorado.png" alt="Logo" class="logo" />

    

    <h1>Recorrido turistico cultural lado oriente</h1>

    <div class="lang-switch">
      <button id="btnEs" class="btn-red-vino">üá≤üáΩ Espa√±ol</button>

      <button id="btnEn" class="btn-red-vino">üá∫üá∏ English</button>
    </div>
  </header>

  <div id="description">
    <p>
      Bienvenido a la ruta en autom√≥vil por la ciudad de Campeche. Visita
      lugares hist√≥ricos y emblem√°ticos que forman parte de su patrimonio
      cultural. Aseg√∫rate de disfrutar cada momento mientras avanzas en el
      recorrido. ¬°Comencemos!
    </p>
  </div>

  <div id="siteMenu" style="text-align: center; margin: 20px">
    <h2>üìç Sitios del Recorrido</h2>

    <div id="siteButtons" style="
          display: flex;
          flex-wrap: wrap;
          justify-content: center;
          gap: 10px;
        "></div>
  </div>

  <div id="distance">Distancia al destino: -</div>

  <!-- Informaci√≥n del recorrido -->

  <div id="tourInfo" class="tour-info">
    <span id="tourInfoText">üí° Haz clic en los iconos del mapa para crear rutas, o usa los botones
      de abajo para ver el recorrido completo</span>
  </div>

  <!-- Estado de ruta activa -->

  <div id="routeStatus" class="route-status">
    <span id="routeStatusText">Ruta activa a: </span>
  </div>

  <!-- Controles de ruta -->

  <div class="route-controls">
    <button id="startRouteBtn" class="btn-red-vino">
      üó∫Ô∏è Ver Recorrido Completo
    </button>

    <button id="startTourBtn" class="btn-red-vino">
      üöó Ir al Primer Sitio
    </button>

    <button id="cancelRouteBtn" class="btn-cancel" style="display: none">
      ‚ùå Cancelar Ruta
    </button>

    <button id="clearAllRoutesBtn" class="btn-cancel" style="display: none">
      üóëÔ∏è Limpiar Todo
    </button>
  </div>

  <div class="container" id="mapContainer">
    <div id="map"></div>

    <!-- Panel lateral -->

    <div id="sidebar">
      <div id="sidebar-content">
        <!-- El contenido se genera din√°micamente -->
      </div>
    </div>
  </div>

  <div style="text-align: center">
    <a href="index.html">
      <button class="btn-back">Regresar al Inicio</button>
    </a>
  </div>

  <footer style="
        background-color: #702c37;
        color: #b38b28;
        text-align: center;
        padding: 30px 10px;
        font-family: 'Arial', sans-serif;
      ">
    <div style="margin-bottom: 20px">
      <!-- Logo -->

      <img src="img/LogoINAH_Dorado2.png" alt="Logo" style="width: 90px; margin-bottom: 10px" />
     
    </div>

    <nav style="margin-bottom: 20px">
      <a href="index.html" style="color: #b38b28; margin: 0 12px; text-decoration: none">Inicio</a>

      <a href="acercaDe.html" style="color: #b38b28; margin: 0 12px; text-decoration: none">Acerca De</a>

      <a href="https://www.google.com/maps/place/Centro+INAH+Campeche/@19.8436519,-90.5397307,16.75z/data=!4m10!1m2!2m1!1sinah!3m6!1s0x85f833f03beef51f:0xbff37f2dee15b654!8m2!3d19.8427132!4d-90.5369075!15sCgRpbmFoIgOIAQGSARBjb3Jwb3JhdGVfb2ZmaWNlqgFFCg0vZy8xMWNra3l5NXh0EAEqCCIEaW5haCgOMh4QASIayUioQwwO0z0YdKzk3fHeSRetwHlMFJs-DXIyCBACIgRpbmFo4AEA!16s%2Fg%2F1tcwlxzc!5m1!1e4?entry=ttu&g_ep=EgoyMDI1MDYyMi4wIKXMDSoASAFQAw%3D%3D" target="_blank" style="color:#b38b28; margin: 0 12px; text-decoration:none;">
      C. 59 39, Zona Centro, 24000 San Francisco de Campeche, Camp.
    </a>

      <a href="tel:+529818115510" style="color: #b38b28; margin: 0 12px; text-decoration: none">
        Contacto
      </a>
    </nav>

    <div style="margin-bottom: 25px">
      <!-- Redes sociales -->

      <a href="https://www.facebook.com/share/19GQgXUWKJ/?mibextid=wwXIfr" target="_blank" style="
            color: #b38b28;
            margin: 0 8px;
            font-size: 18px;
            text-decoration: none;
          ">
        <i class="fab fa-facebook-f"></i>
      </a>

      <a href="https://www.instagram.com/inahsasyuc?igsh=MTczMDg1NGxmYzRyNw==" target="_blank" style="
            color: #b38b28;
            margin: 0 8px;
            font-size: 18px;
            text-decoration: none;
          ">
        <i class="fab fa-instagram"></i>
      </a>

      <a href="https://x.com/inahsas_yuc" target="_blank" style="
            color: #b38b28;
            margin: 0 8px;
            font-size: 18px;
            text-decoration: none;
          ">
        <i class="fab fa-twitter"></i>
      </a>

      <a href="https://youtube.com/@inahtv?si=dTPfND_makjeZTEm" target="_blank" style="
            color: #b38b28;
            margin: 0 8px;
            font-size: 18px;
            text-decoration: none;
          ">
        <i class="fab fa-youtube"></i>
      </a>
    </div>

    <hr style="border-color: #8c5d54; margin-bottom: 15px" />

    <p style="font-size: 14px; margin: 0">
      ¬© 2025 Miguiaa_mx. Todos los derechos reservados.
    </p>

    <p style="font-weight: 600; font-size: 14px; margin: 5px 0 0 0">
      DISE√ëADO POR INAH CAMPECHE
    </p>
  </footer>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>


    // Variables globales

    let map;

    let userMarker;

    let followUser = true;

    let currentCarouselIndex = 0;

    let carouselInterval;

    let blueRouteLine;

    let selectedRouteLine;

    let selectedSite = null;

    let routeToStartLine;

    let distanceInterval;

    let activeRouteType = null; // 'selected', 'start', 'complete'

    let userMovedMap = false;

    // Funci√≥n para detectar si es dispositivo m√≥vil

    function isMobileDevice() {
      return window.innerWidth <= 768;
    }

    // Funci√≥n para hacer scroll suave hacia el contenedor del mapa en m√≥viles

    function scrollToMapOnMobile() {
      if (isMobileDevice()) {
        const mapContainer = document.getElementById("mapContainer");

        if (mapContainer) {
          // Peque√±o delay para que la animaci√≥n del sidebar se complete

          setTimeout(() => {
            mapContainer.scrollIntoView({
              behavior: "smooth",

              block: "start",
            });
          }, 200);
        }
      }
    }

    // Inicializar mapa

    const mapInstance = L.map("map").setView([19.845, -90.523], 12);

    map = mapInstance;

    map.on("movestart", () => {
      followUser = false;

      userMovedMap = true;
    });

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap contributors",
    }).addTo(map);

    // Desactiva el seguimiento si el usuario empieza a mover el mapa manualmente

    map.on("movestart", () => {
      followUser = false;
    });

    map.on("zoomend", () => {
      const zoom = map.getZoom();

      let size = 32;

      if (zoom >= 17) size = 64;
      else if (zoom >= 15) size = 48;
      else if (zoom >= 13) size = 36;
      else size = 28;

      siteIcons = createIcon(size);

      markers.forEach(({ marker, site }) => {
        marker.setIcon(siteIcons[site.name]);
      });
    });

    const translations = {
      es: {
        welcome:
          "Bienvenido a la ruta en autom√≥vil por la ciudad de Campeche. Visita lugares hist√≥ricos y emblem√°ticos que forman parte de su patrimonio cultural. Aseg√∫rate de disfrutar cada momento mientras avanzas en el recorrido. ¬°Comencemos!",

        distance: "Distancia al destino",

        closeSidebar: "Cerrar",

        prevImage: "Anterior",

        nextImage: "Siguiente",

        listenDescription: "Escuchar descripci√≥n",

        centerMap: "Centrar en mapa",

        createRoute: "Crear Ruta a Este Sitio",

        meters: "metros",

        kilometers: "kil√≥metros",

        viewCompleteRoute: "üó∫Ô∏è Ver Recorrido Completo",

        goToFirstSite: "üöó Ir al Primer Sitio",

        cancelRoute: "‚ùå Cancelar Ruta",

        clearAll: "üóëÔ∏è Limpiar Todo",

        routeActive: "Ruta activa a: ",

        routeToStart: "Ruta al sitio m√°s cercano",

        routeCanceled: "Ruta cancelada",

        allRoutesCleared: "Todas las rutas eliminadas",

        tourInfoDefault:
          "üí° Haz clic en los iconos del mapa para crear rutas, o usa los botones de abajo para ver el recorrido completo",

        tourInfoComplete:
          "üó∫Ô∏è Mostrando recorrido completo entre todos los sitios",

        tourInfoToSite:
          "üöó Ruta creada desde tu ubicaci√≥n hasta el sitio m√°s cercano",

        goToRoute: "üöó Ir al Recorrido",

        routeCreated: "Ruta creada hacia",

        locationNotAvailable: "Ubicaci√≥n no disponible",

        "Vapor Lol√°": {
          description:
            "El Vapor Lol√° es un emblem√°tico buque de vapor de la marina mercante francesa que encall√≥ frente a las costas de Campeche en 1864 debido a una maniobra err√≥nea de su capit√°n, seg√∫n una cr√≥nica que data del siglo XX. Con una eslora de 65 metros y una manga de 9.35 metros, esta embarcaci√≥n representa un hito en la evoluci√≥n de la tecnolog√≠a mar√≠tima de la Revoluci√≥n Industrial. Sus restos, visibles desde el malec√≥n Justo Sierra M√©ndez, han sido reconocidos como Patrimonio Cultural Subacu√°tico por el INAH desde 2007.",

          images: [
            "imgOriente/VaporLola1.jpg",
            "imgOriente/VaporLola2.jpg",
            "imgOriente/VaporLola3.jpg",
          ],
        },

        "Bater√≠a de San Luis": {
          description:
            "Construida en 1791 al pie del Fuerte de San Miguel, la Bater√≠a de San Luis es una fortificaci√≥n costera clave en la defensa de Campeche durante el siglo XVIII. Dise√±ada para disparar fuego rasante y evitar desembarcos enemigos, esta estructura rectangular cuenta con un foso, garitas y espacios como cuarteles y almacenes de p√≥lvora. En 1862, protagoniz√≥ un enfrentamiento con la ca√±onera francesa L‚ÄôEclair durante la Segunda Intervenci√≥n Francesa en M√©xico. ",

          images: [
            "imgOriente/sanLuis1.jpg",
            "imgOriente/sanLuis2.jpg",
            "imgOriente/sanLuis3.jpg",
          ],
        },

        "Fuerte de San Miguel": {
          description:
            "El Reducto o Fuerte de San Miguel, dise√±ado por el ingeniero militar Agust√≠n Crame y construido en el siglo XVIII, es una de las estructuras defensivas m√°s importantes del puerto de Campeche. Se ubica en una colina al sur de la ciudad conocida como ‚ÄúCerro de Buenavista‚Äù, ofreciendo una vista panor√°mica de la bah√≠a de Campeche. Su funci√≥n original fue la de vigilar la costa para evitar el desembarco de enemigos por la costa del poblado de Lerma, a√∫n conserva ca√±ones, un foso y su puente levadizo original. Hoy d√≠a, el fuerte alberga el Museo de Arqueolog√≠a Maya, con una destacada colecci√≥n de piezas provenientes de sitios arqueol√≥gicos como Calakmul, Edzn√° y Jaina.",

          images: [
            "imgOriente/sanMiguel1.jpg",
            "imgOriente/sanMiguel2.jpg",
            "imgOriente/sanMiguel3.jpg",
          ],
        },

        "Parque de Lerma": {
          description:
            "Ubicado en el coraz√≥n de la comunidad pesquera de Lerma, a solo 8 km de la ciudad de Campeche. Muy cerca de este parque se encontraba un reducto o fuerte de vigilancia costera que fue demolido a finales del siglo XIX. ¬øSab√≠as que por esta costa desembarcaron piratas como Cristopher Mings, Edward Mansvelt, Laurens de Graaff ‚ÄúLorencillo‚Äù y ‚ÄúBarbillas‚Äù? Este √∫ltimo saque√≥ e incendio el poblado de Lerma y secuestr√≥ al gobernador de Yucat√°n Fernando Meneses y Bravo, pidiendo un rescate para liberarlo. Enfrente se ubica la iglesia en honor a la Virgen de la Asunci√≥n construida en 1812, en el interior cerca de la sacrist√≠a se encuentra la l√°pida funeraria del ilustre marino campechano don Pedro S√°enz de Baranda y Quijano qui√©n falleci√≥ en Lerma en 1891.",

          images: [
            "imgOriente/parqueLerma1.jpg",
            "imgOriente/parqueLerma2.jpg",
            "imgOriente/parqueLerma3.jpg",
          ],
        },

        "Playa Bonita": {
          description:
            "Playa Bonita es una de las playas m√°s visitadas de Campeche, ubicada en el poblado de Lerma, a solo 15 minutos de la ciudad. De aguas tranquilas y arena clara, es ideal para familias y quienes buscan relajarse junto al mar. Cuenta con servicios b√°sicos, restaurantes y √°reas recreativas, lo que la convierte en un lugar c√≥modo y accesible para refrescarse y disfrutar las aguas del Golfo de M√©xico.",

          images: [
            "imgOriente/playaBonita1.jpg",
            "imgOriente/playaBonita2.jpg",
            "imgOriente/playaBonita3.jpg",
          ],
        },
      },

      en: {
        welcome:
          "Welcome to the Campeche City Driving Tour. Visit historic and iconic sites that are part of its cultural heritage. Make sure you enjoy every moment as you travel. Let's get started!",

        distance: "Distance to destination",

        closeSidebar: "Close",

        prevImage: "Previous",

        nextImage: "Next",

        listenDescription: "Listen to description",

        centerMap: "Center on map",

        createRoute: "Create Route to This Site",

        meters: "meters",

        kilometers: "kilometers",

        viewCompleteRoute: "üó∫Ô∏è View Complete Route",

        goToFirstSite: "üöó Go to First Site",

        cancelRoute: "‚ùå Cancel Route",

        clearAll: "üóëÔ∏è Clear All",

        routeActive: "Active route to: ",

        routeToStart: "Route to nearest site",

        routeCanceled: "Route canceled",

        allRoutesCleared: "All routes cleared",

        tourInfoDefault:
          "üí° Click on map icons to create routes, or use the buttons below to view the complete tour",

        tourInfoComplete: "üó∫Ô∏è Showing complete route between all sites",

        tourInfoToSite:
          "üöó Route created from your location to the nearest site",

        goToRoute: "üöó Go to Route",

        routeCreated: "Route created to",

        locationNotAvailable: "Location not available",

        "Vapor Lol√°": {
          description:
            "The Vapor Lol√° is an iconic French merchant marine steamship that ran aground off the coast of Campeche in 1864 due to an erroneous maneuver by its captain, according to a 20th-century chronicle. Measuring 65 meters in length and 9.35 meters wide, this vessel represents a milestone in the evolution of maritime technology during the Industrial Revolution. Its remains, visible from the Justo Sierra M√©ndez seawall, have been recognized as Underwater Cultural Heritage by the INAH (National Institute of Natural History) since 2007.",

          images: [
            "imgOriente/VaporLola1.jpg",
            "imgOriente/VaporLola2.jpg",
            "imgOriente/VaporLola3.jpg",
          ],
        },

        "Bater√≠a de San Luis": {
          description:
            "Built in 1791 at the foot of San Miguel Fort, the San Luis Battery is a key coastal fortification in the defense of Campeche during the 18th century. Designed to fire low and prevent enemy landings, this rectangular structure features a moat, sentry boxes, and spaces for barracks and gunpowder stores. In 1862, it was involved in a clash with the French gunboat  L'Eclair during the Second French Intervention in Mexico.",

          images: [
            "imgOriente/sanLuis1.jpg",
            "imgOriente/sanLuis2.jpg",
            "imgOriente/sanLuis3.jpg",
          ],
        },

        "Fuerte de San Miguel": {
          description:
            'The San Miguel Redoubt or Fort, designed by military engineer Agust√≠n Crame and built in the 18th century, is one of the most important defensive structures in the port of Campeche. It is located on a hill south of the city known as "Cerro de Buenavista," offering a panoramic view of the Bay of Campeche. Its original function was to guard the coast to prevent enemy landings along the shore of the town of Lerma. It still preserves cannons, a moat, and its original drawbridge. Today, the fort houses the Museum of Maya Archaeology, with an outstanding collection of artifacts from archaeological sites such as Calakmul, Edzn√°, and Jaina.',

          images: [
            "imgOriente/sanMiguel1.jpg",
            "imgOriente/sanMiguel2.jpg",
            "imgOriente/sanMiguel3.jpg",
          ],
        },

        "Parque de Lerma": {
          description:
            'Located in the heart of the fishing community of Lerma, just 8 km from the city of Campeche. Very close to this park was a coastal redoubt or fort that was demolished at the end of the 19th century. Did you know that pirates such as Christopher Mings, Edward Mansvelt, Laurens de Graaff "Lorencillo," and "Barbillas" landed on this coast? The latter sacked and burned the town of Lerma and kidnapped the governor of Yucat√°n, Fernando Meneses y Bravo, demanding a ransom for his release. Opposite is the church in honor of the Virgin of the Assumption, built in 1812. Inside, near the sacristy, is the tombstone of the illustrious Campeche sailor Don Pedro S√°enz de Baranda y Quijano, who died in Lerma in 1891.',

          images: [
            "imgOriente/parqueLerma1.jpg",
            "imgOriente/parqueLerma2.jpg",
            "imgOriente/parqueLerma3.jpg",
          ],
        },

        "Playa Bonita": {
          description:
            "Playa Bonita is one of Campeche's most visited beaches, located in the town of Lerma, just 15 minutes from the city. With calm waters and clear sand, it's ideal for families and those looking to relax by the sea. It offers basic services, restaurants, and recreational areas, making it a comfortable and accessible place to cool off and enjoy the waters of the Gulf of Mexico.",

          images: [
            "imgOriente/playaBonita1.jpg",
            "imgOriente/playaBonita2.jpg",
            "imgOriente/playaBonita3.jpg",
          ],
        },
      },
    };

    let currentLang = "es";

    const sites = [
      {
        lat: 19.833565,
        lng: -90.557789,
        name: "Vapor Lol√°",
        image: "img/VaporLola.jpg",
      },

      {
        lat: 19.825526,
        lng: -90.57013,
        name: "Bater√≠a de San Luis",
        image: "img/bateria_san_miguel.jpg",
      },

      {
        lat: 19.824654,
        lng: -90.56867,
        name: "Fuerte de San Miguel",
        image: "img/fuerteSanMiguel.jpg",
      },

      {
        lat: 19.805915,
        lng: -90.600995,
        name: "Parque de Lerma",
        image: "img/parque.jpg",
      },

      {
        lat: 19.7932242,
        lng: -90.6240417,
        name: "Playa Bonita",
        image: "img/playa.jpg",
      },
    ];

    // Crear popup SIMPLE para iconos del mapa (solo imagen, t√≠tulo y bot√≥n)

    function createSimplePopup(site) {
      return ` 

<div class="simple-popup"> 

<h3>${site.name}</h3> 

<img src="${site.image}" alt="${site.name}"> 

<button onclick="startRouteToSite('${site.name}', ${site.lat}, ${site.lng})" class="popup-route-btn"> 

${translations[currentLang].goToRoute} 

</button> 

</div> 

`;
    }

    // Funci√≥n para iniciar ruta desde popup

    function startRouteToSite(siteName, lat, lng) {
      if (!userMarker) {
        console.log("Ubicaci√≥n del usuario no disponible");

        return;
      }

      // Cancelar cualquier ruta existente autom√°ticamente

      if (selectedRouteLine) {
        map.removeLayer(selectedRouteLine);

        selectedRouteLine = null;
      }

      if (routeToStartLine) {
        map.removeLayer(routeToStartLine);

        routeToStartLine = null;
      }

      if (blueRouteLine) {
        map.removeLayer(blueRouteLine);

        blueRouteLine = null;
      }

      // Crear nueva ruta al sitio seleccionado

      const site = sites.find((s) => s.name === siteName);

      if (site) {
        selectedSite = site;

        drawRouteToSite(lat, lng, siteName);
      }

      // Cerrar popup

      map.closePopup();

      closeSidebar();
    }

    // Funci√≥n para crear ruta desde el panel lateral

    function createRouteFromSidebar(siteName) {
      const site = sites.find((s) => s.name === siteName);

      if (!site) return;

      if (!userMarker) {
        console.log("Ubicaci√≥n del usuario no disponible");

        return;
      }

      // Cancelar cualquier ruta existente autom√°ticamente

      if (selectedRouteLine) {
        map.removeLayer(selectedRouteLine);

        selectedRouteLine = null;
      }

      if (routeToStartLine) {
        map.removeLayer(routeToStartLine);

        routeToStartLine = null;
      }

      if (blueRouteLine) {
        map.removeLayer(blueRouteLine);

        blueRouteLine = null;
      }

      // Crear nueva ruta al sitio seleccionado

      selectedSite = site;

      drawRouteToSite(site.lat, site.lng, siteName);

      closeSidebar();
    }

    function createIcon(size = 48) {
      return {
        "Vapor Lol√°": L.icon({
          iconUrl: "iconos/barco.png",

          iconSize: [size, size],

          iconAnchor: [size / 2, size],

          popupAnchor: [0, -size],
        }),

        "Bater√≠a de San Luis": L.icon({
          iconUrl: "iconos/baterias.png",

          iconSize: [size, size],

          iconAnchor: [size / 2, size],

          popupAnchor: [0, -size],
        }),

        "Fuerte de San Miguel": L.icon({
          iconUrl: "iconos/fuerte.png",

          iconSize: [size, size],

          iconAnchor: [size / 2, size],

          popupAnchor: [0, -size],
        }),

        "Parque de Lerma": L.icon({
          iconUrl: "iconos/parque.png",

          iconSize: [size, size],

          iconAnchor: [size / 2, size],

          popupAnchor: [0, -size],
        }),

        "Playa Bonita": L.icon({
          iconUrl: "iconos/playa.png",

          iconSize: [size, size],

          iconAnchor: [size / 2, size],

          popupAnchor: [0, -size],
        }),
      };
    }

    const markers = [];

    sites.forEach((site) => {
      let siteIcons = createIcon(); // tama√±o inicial

      const markers = [];

      sites.forEach((site, index) => {
        const icon = siteIcons[site.name];

        // Agregar el marcador con el icono personalizado

        const marker = L.marker([site.lat, site.lng], { icon }).addTo(map);

        marker.bindPopup(createSimplePopup(site));

        // Crear un marcador de n√∫mero (DivIcon)

        const numberIcon = L.divIcon({
          className: "number-icon",

          html: `<div class="number-label">${index + 1}</div>`,

          iconSize: [24, 24],

          iconAnchor: [12, 12],
        });

        // A√±adir el n√∫mero encima del icono

        const numberMarker = L.marker([site.lat, site.lng], {
          icon: numberIcon,
        }).addTo(map);

        markers.push({ marker, site });
      });
    });

    // Actualizar estado de la interfaz seg√∫n rutas activas

    function updateRouteUI() {
      const routeStatus = document.getElementById("routeStatus");

      const routeStatusText = document.getElementById("routeStatusText");

      const tourInfo = document.getElementById("tourInfo");

      const tourInfoText = document.getElementById("tourInfoText");

      const viewRouteBtn = document.getElementById("startRouteBtn");

      const goToSiteBtn = document.getElementById("startTourBtn");

      const cancelBtn = document.getElementById("cancelRouteBtn");

      const clearBtn = document.getElementById("clearAllRoutesBtn");

      if (selectedSite && selectedRouteLine) {
        // Hay una ruta espec√≠fica a un sitio

        routeStatus.classList.add("active");

        routeStatusText.textContent = `${translations[currentLang].routeActive}${selectedSite.name}`;

        tourInfoText.textContent = `üéØ Ruta espec√≠fica creada hacia: ${selectedSite.name}`;

        cancelBtn.style.display = "inline-block";

        clearBtn.style.display = "inline-block";

        activeRouteType = "selected";
      } else if (routeToStartLine) {
        // Hay una ruta al sitio m√°s cercano

        routeStatus.classList.add("active");

        routeStatusText.textContent = translations[currentLang].routeToStart;

        tourInfoText.textContent = translations[currentLang].tourInfoToSite;

        cancelBtn.style.display = "inline-block";

        clearBtn.style.display = "inline-block";

        activeRouteType = "start";
      } else if (blueRouteLine) {
        // Solo hay ruta completa del recorrido

        routeStatus.classList.remove("active");

        tourInfoText.textContent = translations[currentLang].tourInfoComplete;

        clearBtn.style.display = "inline-block";

        cancelBtn.style.display = "none";

        activeRouteType = "complete";
      } else {
        // No hay rutas activas

        routeStatus.classList.remove("active");

        tourInfoText.textContent = translations[currentLang].tourInfoDefault;

        cancelBtn.style.display = "none";

        clearBtn.style.display = "none";

        activeRouteType = null;
      }

      // Actualizar textos de botones

      viewRouteBtn.textContent = translations[currentLang].viewCompleteRoute;

      goToSiteBtn.textContent = translations[currentLang].goToFirstSite;

      cancelBtn.textContent = translations[currentLang].cancelRoute;

      clearBtn.textContent = translations[currentLang].clearAll;
    }



function clearExistingRoutes() {
  if (selectedRouteLine && map.hasLayer(selectedRouteLine)) {
    map.removeLayer(selectedRouteLine);
    selectedRouteLine = null;
  }

  if (routeToStartLine && map.hasLayer(routeToStartLine)) {
    map.removeLayer(routeToStartLine);
    routeToStartLine = null;
  }

  if (blueRouteLine && map.hasLayer(blueRouteLine)) {
    map.removeLayer(blueRouteLine);
    blueRouteLine = null;
  }

  selectedSite = null;
  localStorage.removeItem("selectedSite");
  document.getElementById("distance").innerText = "Distancia al destino: -";
}






    // Cancelar ruta activa

    function cancelActiveRoute() {
      try {
        // Esto es lo nuevo (debe ir antes que todo)

        selectedSite = null;

        localStorage.removeItem("selectedSite");

        document.getElementById("distance").innerText =
          "Distancia al destino: -";

        if (selectedRouteLine && map.hasLayer(selectedRouteLine)) {
          map.removeLayer(selectedRouteLine);

          selectedRouteLine = null;
        }

        if (routeToStartLine && map.hasLayer(routeToStartLine)) {
          map.removeLayer(routeToStartLine);

          routeToStartLine = null;
        }

        updateRouteUI();
      } catch (error) {
        console.error("Error al cancelar ruta:", error);
      }
    }

    // Limpiar todas las rutas

    function clearAllRoutes() {
      try {
        selectedSite = null;

        localStorage.removeItem("selectedSite");

        document.getElementById("distance").innerText =
          "Distancia al destino: -";

        if (selectedRouteLine && map.hasLayer(selectedRouteLine)) {
          map.removeLayer(selectedRouteLine);

          selectedRouteLine = null;
        }

        if (routeToStartLine && map.hasLayer(routeToStartLine)) {
          map.removeLayer(routeToStartLine);

          routeToStartLine = null;
        }

        if (blueRouteLine && map.hasLayer(blueRouteLine)) {
          map.removeLayer(blueRouteLine);

          blueRouteLine = null;
        }

        updateRouteUI();
      } catch (error) {
        console.error("Error al limpiar rutas:", error);
      }
    }

    // Abrir panel lateral con informaci√≥n del sitio (SOLO desde botones del men√∫)

  async function openSidebar(siteName) {

      const site = sites.find((s) => s.name === siteName);

      if (!site) return;

      const sidebar = document.getElementById("sidebar");

      const sidebarContent = document.getElementById("sidebar-content");

      // Detener carrusel anterior si existe

      if (carouselInterval) {
        clearInterval(carouselInterval);
      }

      // Calcular distancia si hay ubicaci√≥n del usuario

 let distanceInfo = '';
if (userMarker) {
  const userPos = userMarker.getLatLng();

  try {
    const { distance, duration } = await getDistanceAndDurationORS(
      userPos.lat,
      userPos.lng,
      site.lat,
      site.lng
    );

    distanceInfo = `
      <div class="distance-info">
        <span class="distance-label">${translations[currentLang].distance}:</span>
        <span class="distance-value">${distance} km</span>
      </div>
      <div class="distance-info">
        <span class="distance-label">‚è±Ô∏è Tiempo estimado:</span>
        <span class="distance-value">${duration} min</span>
      </div>
    `;
  } catch (error) {
    console.error('Error al calcular distancia/tiempo:', error);
  }
}


      const siteData = translations[currentLang][siteName];

      const images = siteData.images || [site.image];

      sidebarContent.innerHTML = ` 

<div class="sidebar-header"> 

<div class="header-content"> 

<h2>${siteName}</h2> 

${distanceInfo} 

</div> 

<button onclick="closeSidebar()" class="close-btn"> 

‚úï ${translations[currentLang].closeSidebar} 

</button> 

</div> 

<div class="image-carousel"> 

<div class="carousel-container"> 

<div class="carousel-images" id="carousel-images"> 

${images
          .map(
            (img, index) => ` 

<img src="${img}" alt="${siteName}" 

class="carousel-image ${index === 0 ? "active" : ""}" 

data-index="${index}" 

onerror="this.src='${site.image}'"> 

`
          )
          .join("")} 

</div> 

${images.length > 1
          ? ` 

<div class="carousel-controls"> 

<button onclick="prevImage()" class="carousel-btn prev-btn"> 

‚ùÆ ${translations[currentLang].prevImage} 

</button> 

<div class="carousel-indicators"> 

${images
            .map(
              (_, index) => ` 

<span class="indicator ${index === 0 ? "active" : ""}" 

onclick="goToImage(${index})" data-index="${index}"></span> 

`
            )
            .join("")} 

</div> 

<button onclick="nextImage()" class="carousel-btn next-btn"> 

${translations[currentLang].nextImage} ‚ùØ 

</button> 

</div> 

<div class="carousel-progress"> 

<div class="progress-bar" id="progress-bar"></div> 

</div> 

`
          : ""
        } 

</div> 

</div> 

<div class="site-description"> 

<p>${siteData.description}</p> 

<div class="action-buttons"> 

<button onclick="speakDescription('${siteData.description.replace(
          /'/g,
          "\\'"
        )}', '${siteName.replace(
          /'/g,
          "\\'"
        )}'); return false;" class="speak-btn"> 

üîä ${translations[currentLang].listenDescription} 

</button> 

<button onclick="toggleSpeech();" id="pauseBtn" class="speak-btn" style="display: none;"> 

  ‚è∏Ô∏è Pausar 

</button> 

 

<button onclick="centerMapOnSite(${site.lat}, ${site.lng})" class="center-btn"> 

üéØ ${translations[currentLang].centerMap} 

</button> 

<button onclick="createRouteFromSidebar('${siteName}')" class="route-btn"> 

üöó ${translations[currentLang].createRoute} 

</button> 

</div> 

</div> 

`;

      // Mostrar sidebar

      sidebar.classList.add("active");

      // Hacer scroll hacia el mapa en dispositivos m√≥viles

      scrollToMapOnMobile();

      // Inicializar carrusel autom√°tico solo si hay m√∫ltiples im√°genes

      if (images.length > 1) {
        currentCarouselIndex = 0;

        startCarousel(images.length);

        updateProgressBar();
      }
    }

    // Cerrar panel lateral

    function closeSidebar() {
      const sidebar = document.getElementById("sidebar");

      sidebar.classList.remove("active");

      // Detener carrusel

      if (carouselInterval) {
        clearInterval(carouselInterval);
      }

      // SOLO PAUSAR (NO CANCELAR)

      if (
        "speechSynthesis" in window &&
        speechSynthesis.speaking &&
        !speechSynthesis.paused
      ) {
        speechSynthesis.pause();

        isPaused = true;

        const pauseBtn = document.getElementById("pauseBtn");

        if (pauseBtn) pauseBtn.innerText = "‚ñ∂Ô∏è Reanudar";
      }
    }

    // Iniciar carrusel autom√°tico

    function startCarousel(totalImages) {
      updateProgressBar();

      carouselInterval = setInterval(() => {
        nextImage(totalImages);

        updateProgressBar();
      }, 4000);
    }

    // Actualizar barra de progreso del carrusel

    function updateProgressBar() {
      const progressBar = document.getElementById("progress-bar");

      if (progressBar) {
        progressBar.style.width = "0%";

        progressBar.style.transition = "width 4s linear";

        setTimeout(() => {
          progressBar.style.width = "100%";
        }, 50);
      }
    }

    // Navegar a imagen anterior

    function prevImage() {
      const images = document.querySelectorAll(".carousel-image");

      const indicators = document.querySelectorAll(".indicator");

      if (images.length === 0) return;

      images[currentCarouselIndex].classList.remove("active");

      if (indicators[currentCarouselIndex])
        indicators[currentCarouselIndex].classList.remove("active");

      currentCarouselIndex =
        currentCarouselIndex === 0
          ? images.length - 1
          : currentCarouselIndex - 1;

      images[currentCarouselIndex].classList.add("active");

      if (indicators[currentCarouselIndex])
        indicators[currentCarouselIndex].classList.add("active");

      // Reiniciar carrusel autom√°tico

      if (carouselInterval) {
        clearInterval(carouselInterval);

        startCarousel(images.length);
      }
    }

    // Navegar a imagen siguiente

    function nextImage(totalImages = null) {
      const images = document.querySelectorAll(".carousel-image");

      const indicators = document.querySelectorAll(".indicator");

      if (images.length === 0) return;

      const total = totalImages || images.length;

      images[currentCarouselIndex].classList.remove("active");

      if (indicators[currentCarouselIndex])
        indicators[currentCarouselIndex].classList.remove("active");

      currentCarouselIndex = (currentCarouselIndex + 1) % total;

      images[currentCarouselIndex].classList.add("active");

      if (indicators[currentCarouselIndex])
        indicators[currentCarouselIndex].classList.add("active");
    }

    // Ir a imagen espec√≠fica

    function goToImage(index) {
      const images = document.querySelectorAll(".carousel-image");

      const indicators = document.querySelectorAll(".indicator");

      if (images.length === 0) return;

      images[currentCarouselIndex].classList.remove("active");

      if (indicators[currentCarouselIndex])
        indicators[currentCarouselIndex].classList.remove("active");

      currentCarouselIndex = index;

      images[currentCarouselIndex].classList.add("active");

      if (indicators[currentCarouselIndex])
        indicators[currentCarouselIndex].classList.add("active");

      // Reiniciar carrusel autom√°tico

      if (carouselInterval) {
        clearInterval(carouselInterval);

        startCarousel(images.length);
      }
    }

    // Funci√≥n para text-to-speech

    let isPaused = false;

    function speakDescription(text, title) {
      if ("speechSynthesis" in window) {
        speechSynthesis.cancel(); // detener cualquier lectura anterior

        const fullText = `${title}. ${text}`;

        const utterance = new SpeechSynthesisUtterance(fullText);

        utterance.lang = currentLang === "es" ? "es-MX" : "en-US";

        utterance.rate = 0.8;

        const speakBtn = document.querySelector(".speak-btn");

        const pauseBtn = document.getElementById("pauseBtn");

        if (speakBtn) {
          const originalText = speakBtn.innerHTML;

          speakBtn.innerHTML = "‚è∏Ô∏è Reproduciendo...";

          speakBtn.disabled = true;

          if (pauseBtn) {
            pauseBtn.style.display = "inline-block";

            pauseBtn.innerText = "‚è∏Ô∏è Pausar";

            isPaused = false;
          }

          utterance.onend = () => {
            speakBtn.innerHTML = originalText;

            speakBtn.disabled = false;

            if (pauseBtn) {
              pauseBtn.style.display = "none";
            }

            isPaused = false;
          };

          utterance.onerror = () => {
            speakBtn.innerHTML = originalText;

            speakBtn.disabled = false;

            if (pauseBtn) {
              pauseBtn.style.display = "none";
            }

            isPaused = false;
          };
        }

        speechSynthesis.speak(utterance);
      }
    }

    function toggleSpeech() {
      const pauseBtn = document.getElementById("pauseBtn");

      if ("speechSynthesis" in window && speechSynthesis.speaking) {
        if (isPaused) {
          speechSynthesis.resume();

          pauseBtn.innerText = "‚è∏Ô∏è Pausar";

          isPaused = false;
        } else {
          speechSynthesis.pause();

          pauseBtn.innerText = "‚ñ∂Ô∏è Reanudar";

          isPaused = true;
        }
      }
    }

    // Centrar mapa en sitio espec√≠fico

    function centerMapOnSite(lat, lng) {
      map.setView([lat, lng], 16);

      closeSidebar();
    }

    // Geolocalizaci√≥n

    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(onLocationFound, onLocationError, {
        enableHighAccuracy: true,

        timeout: 10000,

        maximumAge: 0,
      });
    } else {
      console.log(
        "La geolocalizaci√≥n no est√° disponible en este dispositivo."
      );
    }

    function onLocationFound(position) {
      const userLocation = L.latLng(
        position.coords.latitude,
        position.coords.longitude
      );

      if (!userMarker) {
        userMarker = L.marker(userLocation)
          .addTo(map)
          .bindPopup("Tu ubicaci√≥n")
          .openPopup();
      } else {
        userMarker.setLatLng(userLocation);
      }

    if (selectedSite && selectedRouteLine) {
  drawRouteToSite(selectedSite.lat, selectedSite.lng, selectedSite.name);
}

    }

    function onLocationError(e) {
      console.error("Error de geolocalizaci√≥n:", e.message);
    }

    // Funciones de rutas (manteniendo la funcionalidad original)

    function getOSRMRoute(sites) {
      const coordinates = sites
        .map((site) => `${site.lng},${site.lat}`)
        .join(";");

      const url = `https://router.project-osrm.org/route/v1/driving/${coordinates}?overview=full&geometries=geojson`;

      fetch(url)
        .then((res) => res.json())

        .then((data) => {
          const coords = data.routes[0].geometry.coordinates.map((c) => [
            c[1],
            c[0],
          ]);

          if (blueRouteLine) {
            map.removeLayer(blueRouteLine);
          }

          blueRouteLine = L.polyline(coords, {
            color: "blue",
            weight: 4,
          }).addTo(map);

          updateRouteUI();
        })

        .catch((err) => console.error("Error al trazar ruta:", err));
    }

    function drawRouteToSite(destLat, destLng, siteName) {
      if (!userMarker) {
        console.log("Ubicaci√≥n del usuario no disponible.");

        return;
      }

      const userLocation = userMarker.getLatLng();

      const start = `${userLocation.lng},${userLocation.lat}`;

      const end = `${destLng},${destLat}`;

      const url = `https://router.project-osrm.org/route/v1/driving/${start};${end}?overview=full&geometries=geojson`;

      if (blueRouteLine) {
        map.removeLayer(blueRouteLine);

        blueRouteLine = null;
      }

      fetch(url)
        .then((res) => res.json())

        .then((data) => {
          const coords = data.routes[0].geometry.coordinates.map((c) => [
            c[1],
            c[0],
          ]);

          if (selectedRouteLine) map.removeLayer(selectedRouteLine);

          selectedRouteLine = L.polyline(coords, {
            color: "red",

            weight: 5,
          }).addTo(map);

          if (!userMovedMap) {
            map.fitBounds(selectedRouteLine.getBounds());
          }

          const dist = (
            userLocation.distanceTo([destLat, destLng]) / 1000
          ).toFixed(2);

          document.getElementById(
            "distance"
          ).innerText = `${translations[currentLang].distance}: ${dist} km`;

          selectedSite = { lat: destLat, lng: destLng, name: siteName };

          localStorage.setItem("selectedSite", JSON.stringify(selectedSite));

          updateRouteUI();
        })

        .catch((err) => {
          console.error("Error al trazar ruta:", err);
        });
    }

    // Crear men√∫ de sitios - SOLO ABRE EL PANEL LATERAL (sin afectar el mapa)

    function createSiteMenu() {
      const container = document.getElementById("siteButtons");

      container.innerHTML = "";

      sites.forEach((site, index) => {
        const btn = document.createElement("button");

        btn.className = "btn-red-vino";

        btn.innerText = `${index + 1}. ${site.name}`;

        btn.onclick = () => {
          // SOLO abrir panel lateral (SIN centrar mapa, SIN mostrar popup, SIN crear ruta)

          openSidebar(site.name);
        };

        container.appendChild(btn);
      });
    }

    // Cambio de idioma

    document.getElementById("btnEs").addEventListener("click", () => {
      currentLang = "es";

      updateUI();
    });

    document.getElementById("btnEn").addEventListener("click", () => {
      currentLang = "en";

      updateUI();
    });

    // Event listeners para botones de control de rutas

    document
      .getElementById("cancelRouteBtn")
      .addEventListener("click", cancelActiveRoute);

    document
      .getElementById("clearAllRoutesBtn")
      .addEventListener("click", clearAllRoutes);

    function updateUI() {
      document.querySelector("#description p").innerText =
        translations[currentLang].welcome;

      // Actualizar popups simples de los marcadores

      markers.forEach(({ marker, site }) => {
        marker.setPopupContent(createSimplePopup(site));
      });

      closeSidebar();

      updateRouteUI();
    }

    // Bot√≥n ver recorrido completo

    document.getElementById("startRouteBtn").addEventListener("click", () => {
      // Limpiar rutas espec√≠ficas si existen

      iclearExistingRoutes();

      localStorage.removeItem("selectedSite");

      document.getElementById("distance").innerText =
        "Distancia al destino: -";

      // Mostrar ruta completa

      if (!blueRouteLine) {
        getOSRMRoute(sites);
      } else {
        // Si ya existe, ajustar vista del mapa

        map.fitBounds(blueRouteLine.getBounds());
      }

      updateRouteUI();
    });

    // Bot√≥n ir al primer sitio (sitio m√°s cercano)

    document.getElementById("startTourBtn").addEventListener("click", () => {
      if (!userMarker) {
        console.log("Ubicaci√≥n del usuario no disponible.");

        return;
      }

      const userLocation = userMarker.getLatLng();

      const nearest = sites.reduce((a, b) => {
        const d1 = userLocation.distanceTo([a.lat, a.lng]);

        const d2 = userLocation.distanceTo([b.lat, b.lng]);

        return d1 < d2 ? a : b;
      });

      const start = `${userLocation.lng},${userLocation.lat}`;

      const end = `${nearest.lng},${nearest.lat}`;

      const url = `https://router.project-osrm.org/route/v1/driving/${start};${end}?overview=full&geometries=geojson`;

      // Limpiar ruta azul si existe

      if (blueRouteLine) {
        map.removeLayer(blueRouteLine);

        blueRouteLine = null;
      }

      fetch(url)
        .then((res) => res.json())

        .then((data) => {
          const coords = data.routes[0].geometry.coordinates.map((c) => [
            c[1],
            c[0],
          ]);

          if (routeToStartLine) map.removeLayer(routeToStartLine);

          routeToStartLine = L.polyline(coords, {
            color: "green",

            weight: 5,

            dashArray: "10,5",
          }).addTo(map);

          map.fitBounds(routeToStartLine.getBounds());

          // Mostrar informaci√≥n del sitio m√°s cercano

          const dist = (
            userLocation.distanceTo([nearest.lat, nearest.lng]) / 1000
          ).toFixed(2);

          document.getElementById(
            "distance"
          ).innerText = `${translations[currentLang].distance}: ${dist} km`;

          updateRouteUI();
        })

        .catch((err) => {
          console.error("Error al trazar ruta:", err);
        });
    });

    // Al cargar la p√°gina

    window.addEventListener("load", () => {
      const saved = localStorage.getItem("selectedSite");

      if (saved && activeRouteType === "selected") {
        const site = JSON.parse(saved);

        selectedSite = site;

        drawRouteToSite(site.lat, site.lng, site.name);
      }
    });

    // Inicializar

    getOSRMRoute(sites);

    createSiteMenu();

    // Limpiar recursos al cerrar

    window.addEventListener("beforeunload", function () {
      if (carouselInterval) {
        clearInterval(carouselInterval);
      }

      if ("speechSynthesis" in window) {
        speechSynthesis.cancel();
      }
    });

    // Manejar cambios de visibilidad de la p√°gina

    document.addEventListener("visibilitychange", function () {
      if (document.hidden) {
        if (carouselInterval) {
          clearInterval(carouselInterval);
        }
      } else {
        const images = document.querySelectorAll(".carousel-image");

        if (images.length > 1) {
          startCarousel(images.length);
        }
      }
    });
    async function getDistanceAndDurationORS(startLat, startLng, endLat, endLng) {
  const body = {
    coordinates: [[startLng, startLat], [endLng, endLat]],
    format: "json"
  };

  const response = await fetch("https://api.openrouteservice.org/v2/directions/driving-car", {
    method: "POST",
    headers: {
      "Authorization": "5b3ce3597851110001cf6248bfa609e880e842169522544426e3be9e",
      "Content-Type": "application/json"
    },
    body: JSON.stringify(body)
  });

  if (!response.ok) throw new Error("Fallo al obtener ruta desde ORS");

  const data = await response.json();
  const distance = data.routes[0].summary.distance; // metros
  const duration = data.routes[0].summary.duration; // segundos

  return {
    distance: (distance / 1000).toFixed(2), // km
    duration: Math.ceil(duration / 60)      // minutos
  };
}

  </script>
</body>

</html>